---
title: "Visualize Community-based Features"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(tidyverse)
require(ggthemes)
require(igraph)

wide_to_long <- function(df, id_var, key_var, val_var, sort_by){
    df %>% t() %>% as.data.frame() %>% 
        rownames_to_column(id_var) %>% 
        arrange(!!sort_by) %>% 
        gather(!!key_var, !!val_var, -(!!id_var)) 
}

poster_theme <- theme(plot.title = element_text(size = 24, face = "bold"), 
                      plot.subtitle =  element_text(size = 10), 
                      axis.text = element_text(size = 15), 
                      axis.title=element_text(size=14,face="bold")) +  
    theme(rect = element_rect(fill = "transparent")) 
poster_scale_color <- scale_color_brewer(palette="Dark2") 
    

cols <- c("Rstudio-related", "base", "Image Plotting",
          "RCpp", "GPS and Geography", "Machine learning",
          "trash", # error
          "Text Analysis", "Social Network Analysis", "Mix of Graphics and Anomaly Detection", 
          "Graph", "Genetics", "Finance", 
          "Insurance and Actuary", "Numerical Optimization", "Sparse Matrix", 
          "Java", "Time, Date, and Money", "Neuronal Science")

community_ids <- list(15, 9, 4, 
                      60, 14, 35, 
                      7,# error
                      36, 25, 39, 
                      23, 19, 31, 
                      8, 64, 73, 
                      18, 20, 120)

cran_graph <- read_rds("cran_graph.RDS")
cran_wc <- read_rds("cran_community_20190518.RDS")
cran_event <- evcent(cran_graph, direct = TRUE)
get_key_members <- function(target_community){
    idx <- which(cols == target_community)
    target_community_id <- community_ids[idx]
    key_members <- tibble(pkg = V(cran_graph)$name, 
                          comm = cran_wc$membership, 
                          evcent = cran_event$vector) %>% 
        filter(comm == target_community_id) %>% 
        arrange(desc(evcent)) %>% 
        head(10) %>% 
        pull(pkg)
    return(key_members)    
}

size_community <- tibble(pkg = V(cran_graph), comm = cran_wc$membership) %>% group_by(comm) %>% summarize(n = n()) %>% arrange(desc(n))
get_size_community <- function(target_community){
    idx <- which(cols == target_community)
    target_community_id <- community_ids[idx]
    size_community %>% filter(comm == target_community_id) %>% pull(n)
}

df_naming_ratio_total <- readRDS('community_df_naming_ratio_total.RDS')
colnames(df_naming_ratio_total) <- cols
rownames(df_naming_ratio_total) <- c("alllower", "ALLUPPER", "UpperCamel", "lowerCamel", "lower_snack", "dotted.func", "other")

df_ratio_total <- readRDS('community_df_ratio_total.RDS')
colnames(df_ratio_total) <- cols
# rownames(df_ratio_total) <- c("")
```

## community

#### what's the size of each community? Also the top 10 package members?
```{r}
size_community
```


## function naming convention
```{r, include=FALSE}
levels_naming <- c("dotted.func", "UpperCamel", "lowerCamel",  "other", "ALLUPPER", "alllower", "lower_snack")
df_naming_ratio_long <- df_naming_ratio_total %>% 
    wide_to_long(id_var = 'community', key_var = 'naming', val_var = 'ratio', sort_by = quo(lower_snack)) %>% 
    mutate(percentage = ratio*100, 
           community=factor(community, levels = unique(community)),
           naming=factor(naming, levels = levels_naming)) 
```

#### overall

#### what's most popular naming convention within community?

- Summary
    - Anomaly Detection is a big fan of lowerCamel, 78%, of great harmony within community. (But suffer from open curly problem most)
    - Java has its own styles => other
    - rstudio is the main advocate of lower_snake style, consistent with the overall trend across years above
    - dotted.fun gains great support from social network analysis
    - Finance, for some reason, uses UpperCamel, which is not common in other communities
    - ALLUPPER is not an abandoned naming
    - dotted.func, only proportional

- Historical reason for them?

```{r, echo=FALSE}
idxmax <- function(vals){
    idx <- which(vals == max(vals))
    return(names(vals)[idx])
}
df_pop <- df_naming_ratio_total %>% t() %>% as.data.frame()
df_pop_summary <- data.frame(community = df_pop %>% apply(2, idxmax), ratio = df_pop %>% apply(2, max)) 
df_pop_summary %>% rownames_to_column(var = "naming") %>% arrange(-ratio) %>% select(community, naming, ratio)

```

- main stream community
    - rstudio
- Community that is different from others
    - anomaly detection: lowerCamel
    - Finance: UpperCamel
    - Java: other
    - Public health: little snake/alllower
```{r naming, echo=FALSE, fig.height = 6, fig.width = 9}
g_naming <- ggplot(aes(y = percentage, x = community, fill = naming), data = df_naming_ratio_long) + 
    geom_bar(stat="identity") + 
    labs(x = "", y = "%") + 
    theme(legend.title = element_blank()) +
    coord_flip() + 
    poster_theme + poster_scale_color

print(g_naming)
ggsave("visualization_community/naming_among_community.png", plot = g_naming, width = 9, height = 6, units = "in", bg = "transparent")
```

#### within each community
```{r, fig.height = 4, fig.width = 6}
get_key_members_subtitle <- function(target_community){
    members <- get_key_members(target_community) 
    line1 <- paste(members[1:3], collapse = ", ")
    line2 <- paste(members[4:6], collapse = ", ")
    line3 <- paste(members[7:10], collapse = ", ")
    top10_members <- paste(line1, line2, line3, sep = "\n")
    total_members <- get_size_community(target_community)
    sprintf("TOP 10 / %s: %s", total_members, top10_members )
}

gen_fig_naming_dist <- function(target_community){
    df_plot <- df_naming_ratio_long %>% filter(community == target_community, 
                                               naming %in% c("lower_snack", "lowerCamel", "UpperCamel", "dotted.func"))
    g <- ggplot(aes(y = percentage, x = naming, fill=naming), data = df_plot) + 
        geom_bar(stat="identity") + ylim(0, 100) +         
        labs(title = target_community, subtitle = get_key_members_subtitle(target_community), x = "", y = "") + 
        theme_hc() + theme(legend.position = "none", 
                           panel.grid.major.y = element_blank(), 
                           axis.text.x = element_blank(), 
                           axis.ticks.x = element_blank()) +
        coord_flip() +
        geom_text(aes(label=sprintf("%s %s", round(percentage, 2), "%")), position = position_dodge(width=0.9), hjust = -0.25) + 
        poster_theme + poster_scale_color
    return(g)
}

communities <- as.character(unique(df_naming_ratio_long$community))
for (comm in communities){
    print(comm)
    g <- gen_fig_naming_dist(comm)
    print(g)
    filename <- sprintf("visualization_community/naming_in_comm_%s.png", comm)
    ggsave(filename, plot = g, width = 6, height = 4, units = "in", bg = "transparent")
}
```




## cake plot: features 
- settle down: most-agreed
    - fx_close_curly
    - fx_semi
    - fx_t_f
    - fx_singleq
    
- rstudio does not good at
    - fx_integer (nr. 1)
    - fx_inflix
    - fx_assign
    - fx_sigleq
    
- lowest variation inside community
    - time, date, and money
    
- everyone need to improve
    - fx_integer
    - fx_infix

```{r features, echo=FALSE, fig.height = 24, fig.width = 12}
levels_feature <- apply(df_ratio_total, 1, max) %>% sort(decreasing = TRUE) %>% names()

df_ratio_long <- df_ratio_total %>% 
    wide_to_long(id_var = 'community', key_var = 'feature', val_var = 'ratio', sort_by = quo(fx_opencurly)) %>% 
    mutate(percentage = ratio*100, 
           community= factor(community, levels = unique(community)),
           feature = factor(feature, levels_feature)) 


g_features <- ggplot(aes(y = percentage, x = community), data = df_ratio_long) + 
    geom_bar(stat="identity", position="dodge") +
    labs(x = "") + 
    facet_grid(feature ~ ., switch="y") + scale_y_continuous("percentage", position="right") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1), 
          strip.text.y=element_text(angle=180)) + 
    poster_theme + poster_scale_color

print(g_features)
ggsave("visualization_community/features_among_community.png", plot = g_features, width = 10, height = 16, units = "in", bg = "transparent")
```
